<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cuddeys Deal Finder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* --- minimal inline styles to make the rates section readable --- */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:16px; margin:12px 0; }
    .card h4 { margin:0 0 8px 0; }
    .tag { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; color:#111; background:#e5f3ff; border:1px solid #cfe7ff; }
    .table-clean { width:100%; border-collapse:collapse; font-size:14px; }
    .table-clean th { text-align:left; background:#f8fafc; color:#111827; border-bottom:1px solid #e5e7eb; padding:8px; }
    .table-clean td { border-bottom:1px solid #f1f5f9; padding:8px; vertical-align:top; }
    .muted { color:#6b7280; }
    .ok { color:#065f46; font-weight:600; }
    .warn { color:#9a3412; font-weight:600; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .pill { font-size:12px; padding:2px 8px; border-radius:10px; border:1px solid #e5e7eb; background:#f9fafb; }
    .subtle { color:#111827; background:#f1f5f9; border:1px solid #e5e7eb; padding:8px 10px; border-radius:6px; display:inline-block; }
    .section-title { margin-top:18px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì¶ Cuddeys Deal Finder</h1>

    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}

    <form method="post">
      <input name="query"    placeholder="Property Address (optional)" />
      <input name="facility" placeholder="Facility Name (optional)" />
      <button type="submit">Search</button>
    </form>

    {% if data.address %}
      <h2>
        Location: {{ data.address }}
        <br>
        <small>{{ data.county }} County, {{ data.state }}</small>
      </h2>

      <h3>üõ£Ô∏è Street View</h3>
      <iframe
        width="100%" height="250" frameborder="0" style="border:0"
        src="https://www.google.com/maps/embed/v1/streetview?key={{ google_api_key }}&location={{ data.lat }},{{ data.lng }}&fov=80"
        allowfullscreen>
      </iframe>

      <h3>üè¢ Google Business Profile</h3>
      {% if data.place.name %}
        <p><strong>{{ data.place.name }}</strong></p>
        <p>üìû {{ data.place.formatted_phone_number|default('N/A') }}</p>
        <p>
          üîó
          {% if data.place.website %}
            <a href="{{ data.place.website }}" target="_blank">
              {{ data.place.website }}
            </a>
          {% else %}
            N/A
          {% endif %}
        </p>
        <p>
          ‚≠ê {{ data.place.rating|default('N/A') }}
          ({{ data.place.user_ratings_total|default(0) }} reviews)
        </p>
        {% if data.place.opening_hours %}
          <ul>
            {% for h in data.place.opening_hours.weekday_text %}
              <li>{{ h }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if data.place.reviews %}
          <p><strong>üí¨ Top 3 Reviews:</strong></p>
          <ul>
            {% for r in data.place.reviews[:3] %}
              <li>
                <strong>{{ r.author_name }}</strong>
                ({{ r.rating }}‚≠ê):
                {{ r.text }}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% else %}
        <p>No Google Business profile found.</p>
      {% endif %}

      <h3>üìÑ Appraisal & Ownership Data</h3>
      {% if data.cad.owner_name %}
        <p><strong>Owner:</strong> {{ data.cad.owner_name }}</p>
        <p><strong>Mailing:</strong> {{ data.cad.mailing_address }}</p>
        <p><strong>Tax ID:</strong> {{ data.cad.tax_id }}</p>
      {% elif data.cad.link %}
        <p>
          <a href="{{ data.cad.link }}" target="_blank">
            Search {{ data.county }} County Appraisal District
          </a>
        </p>
      {% else %}
        <p>No CAD data available.</p>
      {% endif %}

      <h3>üè∑Ô∏è LLC & Entity Tracing</h3>
      {% if data.llc.llc_name %}
        <p>
          <strong>LLC:</strong>
          <a href="{{ data.llc.opencorporates_url }}" target="_blank">
            {{ data.llc.llc_name }}
          </a>
        </p>
        <p><strong>Formed:</strong> {{ data.llc.formation_date|default('N/A') }}</p>
        <p>
          <strong>SOS:</strong>
          <a href="{{ data.llc.sos_url }}" target="_blank">
            View in TX SOS
          </a>
        </p>
      {% else %}
        <p>No LLC data.</p>
      {% endif %}

      <h3>üåê Owner Web Presence</h3>
      {% if data.owner_web %}
        <ul>
          {% for w in data.owner_web %}
            <li>
              <p>
                <a href="{{ w.url }}" target="_blank">
                  {{ w.title }}
                </a>
              </p>
              {% if w.description %}
                <p>{{ w.description }}</p>
              {% endif %}
              {% if w.emails %}
                <p>Emails: {{ w.emails|join(', ') }}</p>
              {% endif %}
              {% if w.phones %}
                <p>Phones: {{ w.phones|join(', ') }}</p>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No owner presence found online.</p>
      {% endif %}

      <h3>üìë Nearby Listings & Valuation</h3>
      {% if data.listings %}
        <table>
          <tr>
            <th>Source</th><th>Name</th><th>Size SF</th>
            <th>Price</th><th>$/SF</th><th>Link</th>
          </tr>
          {% for l in data.listings %}
            <tr>
              <td>{{ l.source }}</td>
              <td>{{ l.name }}</td>
              <td>{{ l.nrsf }}</td>
              <td>${{ "{:,.0f}".format(l.price) }}</td>
              <td>${{ l.ppsf }}</td>
              <td>
                <a href="{{ l.link }}" target="_blank">view</a>
              </td>
            </tr>
          {% endfor %}
        </table>
        <p>Recommended $/SF based on comps: ${{ data.recommended_ppsf }}</p>
        <p>Estimated value for {{ data.nrsf }} SF: ${{ "{:,.0f}".format(data.recommended_value) }}</p>
      {% else %}
        <p>No nearby listings found.</p>
      {% endif %}

      <!-- === NEW: Competitor Rates Comparison (organized + color cues) === -->
      <h3 class="section-title">üìä Competitor Rates Comparison</h3>

      {% set sizes = ['5x5','5x10','10x10','10x15','10x20','10x30'] %}

      <div class="card">
        <h4>Subject Property Rates</h4>
        {% if data.place.name %}
          <div class="muted">{{ data.place.name }} {% if data.place.website %}¬∑ <a href="{{ data.place.website }}" target="_blank">website</a>{% endif %}</div>
        {% endif %}
        <table class="table-clean">
          <tr>
            <th>Unit Size</th>
            <th>Climate</th>
            <th>Non-Climate</th>
          </tr>
          {% for s in sizes %}
            <tr>
              <td><span class="pill">{{ s }}</span></td>
              <td>{% set v = data.subject_rates.get(s, {}).get('climate') %}{{ ('$' + "{:,.0f}".format(v)) if v is not none else '‚Äî' }}</td>
              <td>{% set v = data.subject_rates.get(s, {}).get('non_climate') %}{{ ('$' + "{:,.0f}".format(v)) if v is not none else '‚Äî' }}</td>
            </tr>
          {% endfor %}
        </table>
      </div>

      <div class="card">
        <h4>Market Summary (within 5 miles)</h4>
        <table class="table-clean">
          <tr>
            <th>Unit Size</th>
            <th>Avg Comp (CC)</th>
            <th>Max Comp (CC)</th>
            <th>‚Üë Potential (vs Max CC)</th>
            <th>Avg Comp (NC)</th>
            <th>Max Comp (NC)</th>
            <th>‚Üë Potential (vs Max NC)</th>
          </tr>
          {% for s in sizes %}
            {% set row = data.rate_analysis.get(s, {}) %}
            <tr>
              <td><span class="pill">{{ s }}</span></td>
              <td>${{ "{:,.0f}".format(row.get('comp_avg_climate', 0)) }}</td>
              <td>${{ "{:,.0f}".format(row.get('comp_max_climate', 0)) }}</td>
              {% set inc_cc = row.get('increase_pct_climate', 0) %}
              <td class="{{ 'ok' if inc_cc>0 else 'muted' }}">{{ inc_cc }}%</td>
              <td>${{ "{:,.0f}".format(row.get('comp_avg_non_climate', 0)) }}</td>
              <td>${{ "{:,.0f}".format(row.get('comp_max_non_climate', 0)) }}</td>
              {% set inc_nc = row.get('increase_pct_non_climate', 0) %}
              <td class="{{ 'ok' if inc_nc>0 else 'muted' }}">{{ inc_nc }}%</td>
            </tr>
          {% endfor %}
        </table>
        <p class="muted" style="margin-top:8px;">‚Üë Potential compares your subject rate to the market‚Äôs highest detected rate for the same climate bucket.</p>
      </div>

      <div class="card">
        <h4>Competitor Details</h4>
        {% if data.competitor_rates and data.competitor_rates|length > 0 %}
          <div class="grid">
            {% for comp in data.competitor_rates %}
              <div class="subtle">
                <div><strong>{{ comp.name }}</strong></div>
                <div class="muted">{{ comp.vicinity }}</div>
                {% if comp.website %}<div><a href="{{ comp.website }}" target="_blank">website</a></div>{% endif %}
                {% if comp.rates %}
                  <table class="table-clean" style="margin-top:8px;">
                    <tr><th>Unit Size</th><th>Climate</th><th>Non-Climate</th></tr>
                    {% for k, v in comp.rates.items() %}
                      <tr>
                        <td><span class="pill">{{ k }}</span></td>
                        <td>{% if v.climate is not none %}${{ "{:,.0f}".format(v.climate) }}{% else %}‚Äî{% endif %}</td>
                        <td>{% if v.non_climate is not none %}${{ "{:,.0f}".format(v.non_climate) }}{% else %}‚Äî{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </table>
                {% else %}
                  <div class="muted">No rates detected.</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">No competitor rate pages could be detected.</p>
        {% endif %}
      </div>
      <!-- === END NEW === -->

      <h3>üí≤ Tax History</h3>
      {% if data.tax_records %}
        <ul>
          {% for t in data.tax_records %}
            <li>{{ t.year }} : ${{ "{:,.0f}".format(t.tax) }}</li>
          {% endfor %}
        </ul>
        <p>Average annual tax: ${{ "{:,.0f}".format(data.avg_tax) }}</p>
      {% else %}
        <p>No tax history available.</p>
      {% endif %}

      <h3>üìà Deal Score</h3>
      <p>
        <strong>{{ data.score }}</strong>
        (Cap: {{ data.cap }}%, ${{ data.ppsf }}/SF)
      </p>

      <!-- Competitor Map -->
      <h3>üó∫Ô∏è Competitor Map</h3>
      <div id="map" style="width:100%; height:400px"></div>
      <script>
        function initMap() {
          const center = { lat: {{ data.lat }}, lng: {{ data.lng }} };
          const map = new google.maps.Map(
            document.getElementById('map'),
            { center: center, zoom: 12 }
          );
          new google.maps.Marker({ position: center, map: map, title: "Subject" });
          {% for c in data.market.competitors_5 %}
            new google.maps.Marker({
              position: { lat: {{ c.lat }}, lng: {{ c.lng }} },
              map: map,
              title: "{{ c.name }}"
            });
          {% endfor %}
        }
      </script>
      <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
      </script>

    {% endif %}
  </div>
</body>
</html>
