<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cuddeys Deal Finder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% if data.address %}
    <!-- Street View iframe with single line src -->
    <h3>ğŸ›£ï¸ Street View</h3>
    <iframe
      width="100%" height="250" frameborder="0" style="border:0"
      src="https://www.google.com/maps/embed/v1/streetview?key={{ google_api_key }}&location={{ data.lat }},{{ data.lng }}&heading=210&pitch=10&fov=80"
      allowfullscreen>
    </iframe>
  {% endif %}
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ Cuddeys Deal Finder</h1>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    <form method="post">
      <input name="query"    placeholder="Property Address (optional)" />
      <input name="facility" placeholder="Facility Name (optional)" />
      <button type="submit">Search</button>
    </form>

    {% if data.address %}
      <!-- Existing business profile and data sections omitted for brevity -->

      <h3>ğŸ“‘ Nearby Listings & Valuation</h3>
      {% if data.listings %}
        <table>
          <tr>
            <th>Source</th><th>Name</th><th>Size SF</th>
            <th>Price</th><th>$/SF</th><th>Link</th>
          </tr>
          {% for l in data.listings %}
            <tr>
              <td>{{ l.source }}</td>
              <td>{{ l.name }}</td>
              <td>{{ l.nrsf }}</td>
              <td>${{ "{:,.0f}".format(l.price) }}</td>
              <td>${{ l.ppsf }}</td>
              <td><a href="{{ l.link }}" target="_blank">view</a></td>
            </tr>
          {% endfor %}
        </table>
        <p>Recommended $/SF based on comps: ${{ data.recommended_ppsf }}</p>
        <p>Estimated value for {{ data.nrsf }} SF: ${{ "{:,.0f}".format(data.recommended_value) }}</p>
      {% else %}
        <p>No nearby listings found.</p>
      {% endif %}

      <h3>ğŸ’² Tax History</h3>
      {% if data.tax_records %}
        <ul>
          {% for t in data.tax_records %}
            <li>{{ t.year }} : ${{ "{:,.0f}".format(t.tax) }}</li>
          {% endfor %}
        </ul>
        <p>Average annual tax: ${{ "{:,.0f}".format(data.avg_tax) }}</p>
      {% else %}
        <p>No tax history available.</p>
      {% endif %}

      <!-- Competitor map container -->
      <h3>ğŸ—ºï¸ Competitor Map</h3>
      <div id="map" style="width:100%; height:400px"></div>

      <!-- initMap defined before loading API -->
      <script>
        function initMap() {
          const center = { lat: {{ data.lat }}, lng: {{ data.lng }} };
          const map = new google.maps.Map(
            document.getElementById('map'),
            { center: center, zoom: 12 }
          );
          new google.maps.Marker({ position: center, map: map, title: "Subject" });
          {% for c in data.market.competitors_5 %}
            new google.maps.Marker({
              position: { lat: {{ c.lat }}, lng: {{ c.lng }} },
              map: map,
              title: "{{ c.name }}"
            });
          {% endfor %}
        }
      </script>
      <!-- load API after initMap and after div exists -->
      <script
        async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
      </script>

      <h3>ğŸ“ˆ Deal Score</h3>
      <p>
        <strong>{{ data.score }}</strong>
        (Cap: {{ data.cap }}%, ${{ data.ppsf }}/SF)
      </p>
    {% endif %}
  </div>
</body>
</html>
